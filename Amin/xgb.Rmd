---
title: "xgb"
author: "Amin Shirazi"
date: "4/17/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(caret)
library(magrittr)
require(xgboost)
library(stringr)
```

```{r}
rm.var <- c('X',
            'BOROUGH',
            'NEIGHBORHOOD',
            'BLOCK', 
            'LOT', 
            'EASE.MENT', 
            'ADDRESS', 
            'APARTMENT.NUMBER',
            'TOTAL.UNITS'
            )
train <- read.csv('../data/train.csv')
train <- train %>% select(- all_of(rm.var))

test<- read.csv('../data/test.csv')
id<-test[ , "INDEX"]
test <- test %>% select(-X, -INDEX, - all_of(rm.var))
```

```{r}

df.train = train %>% 
     mutate(
         BUILDING.CLASS.CATEGORY = as.factor(BUILDING.CLASS.CATEGORY),
         BUILDING.CLASS.AT.PRESENT = as.factor(BUILDING.CLASS.AT.PRESENT),
         BUILDING.CLASS.AT.TIME.OF.SALE = as.factor(BUILDING.CLASS.AT.TIME.OF.SALE), 
         TAX.CLASS.AT.PRESENT = as.factor(TAX.CLASS.AT.PRESENT), 
         TAX.CLASS.AT.TIME.OF.SALE = as.factor(TAX.CLASS.AT.TIME.OF.SALE), 
         SALE.DATE =  as.Date(SALE.DATE))
levels(df.train$BUILDING.CLASS.CATEGORY) <- c(1, 2, 3, 4, 5)
df.train %>% names()
```

```{r}
Numdf<-df.train[1:100, ]

for (i in 1:16) {
  Numdf[,i]<-as.double(Numdf[,i])
}


XGBTune<-train(y=Numdf[,11],
              x=Numdf[,-11],
              method="xgbTree",
              verbose=FALSE,
              trControl= trainControl(method="repeatedcv",repeats = 1, number=10 , allowParallel=TRUE))
```

## Results for xgb with Zip code
```{r}
xgbtune1 <- readRDS("./xgb/with_zip/xgbtune1.rds")
xgbtune2 <- readRDS("./xgb/with_zip/xgbtune2.rds")
xgbtune3 <- readRDS("./xgb/with_zip/xgbtune3.rds")
xgbtune4 <- readRDS("./xgb/with_zip/xgbtune4.rds")
xgbtune5 <- readRDS("./xgb/with_zip/xgbtune5.rds")
xgbtune6 <- readRDS("./xgb/with_zip/xgbtune6.rds")
xgbtune7 <- readRDS("./xgb/with_zip/xgbtune7.rds")
```

```{r}
grab_rmse<-function(tune){
  index<-which.min(tune$results$RMSE)
  tune$results[index,]$RMSE
}

xgbtune7$bestTune
all.tunes<-list(xgbtune1, xgbtune2, xgbtune3, xgbtune4, xgbtune5)
all.RMSE<-lapply(all.tunes, grab_rmse)
all.RMSE
```

```{r}
df.test <- test %>% 
  mutate(
         BUILDING.CLASS.CATEGORY = as.factor(BUILDING.CLASS.CATEGORY),
         BUILDING.CLASS.AT.PRESENT = as.factor(BUILDING.CLASS.AT.PRESENT),
         BUILDING.CLASS.AT.TIME.OF.SALE = as.factor(BUILDING.CLASS.AT.TIME.OF.SALE), 
         TAX.CLASS.AT.PRESENT = as.factor(TAX.CLASS.AT.PRESENT), 
         TAX.CLASS.AT.TIME.OF.SALE = as.factor(TAX.CLASS.AT.TIME.OF.SALE), 
         LAND.SQUARE.FEET = log(as.numeric(as.factor(LAND.SQUARE.FEET))+1), 
         GROSS.SQUARE.FEET = log(as.numeric(as.factor(GROSS.SQUARE.FEET))+1), 
         SALE.DATE = SALE.DATE %>% lubridate::mdy())
levels(df.test$BUILDING.CLASS.CATEGORY) <- c(1, 2, 3, 4, 5)
```

```{r}
Numdf<-df.test

for (i in 1:16) {
  Numdf[,i]<-as.double(Numdf[,i])
}

pred<-predict(xgbtune5, Numdf) #df.test is the manipulated df of test 
pred<-exp(pred)
solution<-data.frame("INDEX"=id,"PRICE"= pred)
write.csv(solution, 
          paste0("../submission/solution", format(Sys.time(), "%d-%b-%Y %H.%M"), ".csv"), 
          row.names = FALSE)
```


























